<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pizza Calculator</title>

<style>
  body {
    font-family: sans-serif;
    background: #fafafa;
    margin: 0;
    padding: 1rem;
  }

  h2 {
    margin-top: 2rem;
    margin-bottom: 0.5rem;
  }

  .block {
    background: #ffffff;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
  }

  .row {
    display: flex;
    align-items: center;
    margin: 0.4rem 0;
  }

  .row label {
    flex: 1;
    font-weight: 600;
  }

  .value-box {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .value-display {
    min-width: 60px;
    text-align: center;
    padding: 0.4rem;
    border-radius: 6px;
    background: #f0f0f0;
    font-weight: 600;
  }

  .step-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: none;
    font-size: 20px;
    background: #e0e0e0;
  }

  select, input[type="number"] {
    padding: 0.4rem;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  .small-note {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.5rem;
  }

  .results-block {
    background: #fffceb;
    padding: 1rem;
    border-radius: 12px;
    margin-top: 1rem;
    border: 1px solid #f0e2aa;
  }

  .result-line {
    font-size: 1.1rem;
    margin-bottom: 0.4rem;
  }

  #profileDirtyWarning {
    display:none;
    color:#b30000;
    font-weight:700;
    margin-top:0.4rem;
  }

  .profile-row {
    display: flex;
    gap: 0.5rem;
    margin: 0.6rem 0;
  }

  .profile-row button {
    padding: 0.4rem 0.7rem;
    border-radius: 8px;
    border: none;
    background: #dfe7ff;
    font-weight: 600;
  }

</style>
</head>

<body>

<h2>ğŸ› ×”×’×“×¨×•×ª ×¤×™×¦×”</h2>
<div class="block">

  <!-- ×¦×•×¨×” -->
  <div class="row">
    <label>×¦×•×¨×”</label>
    <div>
      <label><input type="radio" name="shape" value="round" checked> ×¢×’×•×œ×”</label>
      &nbsp;&nbsp;
      <label><input type="radio" name="shape" value="rect"> ××œ×‘× ×™×ª</label>
    </div>
  </div>

  <!-- ××¦×‘ ×¢×•×‘×™ / ××©×§×œ -->
  <div class="row">
    <label>××•×¤×Ÿ ×—×™×©×•×‘</label>
    <div>
      <label><input type="radio" name="mode" value="thickness" checked> ×§×•×‘×¢ ×¢×•×‘×™ â†’ ××§×‘×œ ××©×§×œ</label><br>
      <label><input type="radio" name="mode" value="weight"> ×§×•×‘×¢ ××©×§×œ â†’ ××§×‘×œ ×¢×•×‘×™</label>
    </div>
  </div>

  <!-- ×§×•×˜×¨ -->
  <div id="roundFields">
    <div class="row">
      <label>×§×•×˜×¨ (×¡×´×)</label>
      <div class="value-box">
        <button class="step-btn" data-target="diameter" data-step="-1">âˆ’</button>
        <input type="number" id="diameter" value="30" min="10" max="60" style="width:80px">
        <button class="step-btn" data-target="diameter" data-step="1">+</button>
      </div>
    </div>
  </div>

  <!-- ××œ×‘× ×™ -->
  <div id="rectFields" style="display:none">
    <div class="row">
      <label>××•×¨×š (×¡×´×)</label>
      <div class="value-box">
        <button class="step-btn" data-target="length" data-step="-1">âˆ’</button>
        <input type="number" id="length" value="30" min="10" max="60" style="width:80px">
        <button class="step-btn" data-target="length" data-step="1">+</button>
      </div>
    </div>

    <div class="row">
      <label>×¨×•×—×‘ (×¡×´×)</label>
      <div class="value-box">
        <button class="step-btn" data-target="width" data-step="-1">âˆ’</button>
        <input type="number" id="width" value="20" min="10" max="60" style="width:80px">
        <button class="step-btn" data-target="width" data-step="1">+</button>
      </div>
    </div>
  </div>

  <!-- ×¢×•×‘×™ -->
  <div id="thicknessRow">
    <div class="row">
      <label>×¢×•×‘×™</label>
      <div class="value-box">
        <button class="step-btn" data-target="thickness" data-step="-0.01">âˆ’</button>
        <div class="value-display" id="thickness">0.39</div>
        <button class="step-btn" data-target="thickness" data-step="0.01">+</button>
      </div>
      <div class="small-note">××‘×•×¡×¡ ×¢×œ 30 ×¡×´× / 276 ×’×¨×</div>
    </div>
  </div>

  <!-- ××©×§×œ ×œ×¤×™×¦×” -->
  <div id="doughPerPizzaRow" style="display:none">
    <div class="row">
      <label>××©×§×œ ×œ×¤×™×¦×” (×’×¨×)</label>
      <input type="number" id="doughPerPizzaInput" value="276" min="50" max="1000">
    </div>
  </div>

  <!-- ×¤×™×¦×•×ª -->
  <div class="row">
    <label>××¡×¤×¨ ×¤×™×¦×•×ª</label>
    <div class="value-box">
      <button class="step-btn" data-target="pizzaCount" data-step="-1">âˆ’</button>
      <div class="value-display" id="pizzaCount">1</div>
      <button class="step-btn" data-target="pizzaCount" data-step="1">+</button>
    </div>
  </div>

</div>

<!-- ×–××Ÿ ×•×˜××¤ -->
<h2>ğŸ•’ ×–××Ÿ ×•×˜××¤×¨×˜×•×¨×”</h2>
<div class="block">

  <div class="row">
    <label>×–××Ÿ (×©×¢×•×ª)</label>
    <div class="value-box">
      <button class="step-btn" data-target="hours" data-step="-0.5">âˆ’</button>
      <div class="value-display" id="hours">6.0</div>
      <button class="step-btn" data-target="hours" data-step="0.5">+</button>

      <button class="step-btn" data-target="hours" data-step="-1">âˆ’âˆ’</button>
      <button class="step-btn" data-target="hours" data-step="1">++</button>
    </div>
  </div>

  <div class="row">
    <label>×˜××¤×¨×˜×•×¨×” (Â°C)</label>
    <div class="value-box">
      <button class="step-btn" data-target="tempC" data-step="-0.5">âˆ’</button>
      <div class="value-display" id="tempC">25.0</div>
      <button class="step-btn" data-target="tempC" data-step="0.5">+</button>
    </div>
  </div>
</div>

<!-- ×¤×¨×•×¤×™×œ + ××¨×›×™×‘×™ ×‘×¦×§ -->
<h2>ğŸ§ª ××¨×›×™×‘×™ ×”×‘×¦×§</h2>
<div class="block">

  <div class="profile-row">
    <select id="profileSelect">
      <option value="">×œ×œ× ×¤×¨×•×¤×™×œ</option>
    </select>
    <button id="saveProfileBtn">×©××•×¨</button>
    <button id="reloadProfileBtn">â†º ×©×—×–×¨</button>
    <button id="deleteProfileBtn">××—×§</button>
  </div>

  <div class="small-note">
    ×‘×—×¨ ×¤×¨×•×¤×™×œ ×§×™×™× ××• ×©××•×¨ ××ª ×”×”×’×“×¨×•×ª ×”× ×•×›×—×™×•×ª ×›×¤×¨×•×¤×™×œ ×—×“×©.
  </div>

  <div id="profileDirtyWarning">×”×¤×¨×•×¤×™×œ ×©×•× ×”</div>

  <!-- ×”×™×“×¨×¦×™×” -->
  <div class="row">
    <label>×”×™×“×¨×¦×™×” (%)</label>
    <div class="value-box">
      <button class="step-btn" data-target="hydration" data-step="-1">âˆ’</button>
      <div class="value-display" id="hydration">60</div>
      <button class="step-btn" data-target="hydration" data-step="1">+</button>
    </div>
  </div>

  <!-- ××œ×— -->
  <div class="row">
    <label>××œ×— (%)</label>
    <div class="value-box">
      <button class="step-btn" data-target="saltPct" data-step="-0.1">âˆ’</button>
      <div class="value-display" id="saltPct">2.5</div>
      <button class="step-btn" data-target="saltPct" data-step="0.1">+</button>
    </div>
  </div>

  <!-- ×©××Ÿ -->
  <div class="row">
    <label>×©××Ÿ (%)</label>
    <div class="value-box">
      <button class="step-btn" data-target="oilPct" data-step="-0.1">âˆ’</button>
      <div class="value-display" id="oilPct">2.0</div>
      <button class="step-btn" data-target="oilPct" data-step="0.1">+</button>
    </div>
  </div>

  <!-- ×¡×•×›×¨ -->
  <div class="row">
    <label>×¡×•×›×¨ (%)</label>
    <div class="value-box">
      <button class="step-btn" data-target="sugarPct" data-step="-0.1">âˆ’</button>
      <div class="value-display" id="sugarPct">1.0</div>
      <button class="step-btn" data-target="sugarPct" data-step="0.1">+</button>
    </div>
  </div>

  <!-- ×©××¨×™× -->
  <div class="row">
    <label>×©××¨×™× (%)</label>
    <div class="value-box">
      <button class="step-btn" data-target="yeastScale" data-step="-0.01">âˆ’</button>
      <div class="value-display" id="yeastScale">0.50</div>
      <button class="step-btn" data-target="yeastScale" data-step="0.01">+</button>
    </div>
  </div>

  <div class="small-note">
    ×”×’×“×¨×•×ª ××ª×§×“××•×ª ×œ×©××¨×™× ×–××™× ×•×ª ×œ××˜×”.
  </div>

  <!-- ××ª×§×“××•×ª -->
  <details style="margin-top:0.6rem">
    <summary>×”×’×“×¨×•×ª ×©××¨×™× ××ª×§×“××•×ª</summary>

    <div class="row" style="margin-top:0.8rem">
      <label>×©×™××•×© ×‘×¢×¨×š ×™×“× ×™</label>
      <input type="checkbox" id="yeastOverrideEnabled">
    </div>

    <div class="row">
      <label>×¢×¨×š ×™×“× ×™ (%)</label>
      <div class="value-box">
        <button class="step-btn" data-target="yeastOverride" data-step="-0.01">âˆ’</button>
        <div class="value-display" id="yeastOverride">0.50</div>
        <button class="step-btn" data-target="yeastOverride" data-step="0.01">+</button>
      </div>
    </div>

  </details>

</div>

<!-- ×ª×•×¦××•×ª -->
<h2>ğŸ“¦ ×ª×•×¦××•×ª</h2>
<div class="results-block">

  <div class="result-line" id="resultSingle"></div>
  <div class="result-line" id="resultTotal"></div>

  <h3 style="margin-top:1rem;">××¨×›×™×‘×™× (×¡×”×´×›):</h3>
  <div id="resultIngredients"></div>

</div>

<script>
/* ============================================================
   CONSTANTS + STORAGE KEYS
============================================================ */

const STORAGE_KEY = "pizzaCalcState_v1";
const PROFILES_KEY = "pizzaCalcProfiles_v1";

/* ============================================================
   PROFILE â€” DIRTY STATE DETECTION
============================================================ */

let currentProfileName = "";
let currentProfileBase = null;

const PROFILE_FIELDS = [
  "shape", "mode",
  "diameter", "length", "width",
  "thicknessFactor", "doughPerPizzaInput",
  "hydrationPct", "saltPct", "oilPct", "sugarPct",
  "yeastScale", "yeastOverridePct"
];

// detect changes
function isProfileDirty(currentState) {
  if (!currentProfileBase) return false;

  // shape change always counts as dirty
  if (currentProfileBase.shape !== currentState.shape) {
    return true;
  }

  return PROFILE_FIELDS.some(key => {
    const ref = currentProfileBase[key];
    const now = currentState[key];

    if (ref == null && now == null) return false;

    const r = Number(ref ?? 0);
    const n = Number(now ?? 0);

    return Math.abs(r - n) > 0.000001;
  });
}

function updateProfileDirtyWarning(isDirty) {
  const el = document.getElementById("profileDirtyWarning");
  if (!el) return;
  el.style.display = isDirty ? "block" : "none";
}

/* ============================================================
   DEBOUNCE
============================================================ */
function debounce(fn, delay = 50) {
  let t;
  return function (...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), delay);
  };
}

/* ============================================================
   YEAST TABLE (×›××• ×©×¡×™×›×× ×•)
============================================================ */

const yeastTable = {
  // temp: { hours : percent }
  14: {2:1.246,3:1.112,4:0.896,5:0.704,6:0.576,7:0.448,8:0.384,9:0.32,10:0.288,12:0.224,16:0.167,20:0.112,24:0.102,28:0.079,32:0.056,36:0.042},
  15: {2:1.224,3:0.986,4:0.832,5:0.64,6:0.5,7:0.384,8:0.32,9:0.256,10:0.224,12:0.192,16:0.128,20:0.099,24:0.075,28:0.052,32:0.048,36:0.036},
  16: {2:1.112,3:0.896,4:0.704,5:0.512,6:0.384,7:0.32,8:0.256,9:0.224,10:0.192,12:0.16,16:0.12,20:0.08,24:0.052,28:0.048,32:0.04,36:0.03},
  17: {2:0.968,3:0.768,4:0.576,5:0.39,6:0.32,7:0.256,8:0.224,9:0.192,10:0.16,12:0.128,16:0.099,20:0.064,24:0.048,28:0.04,32:0.032,36:0.028},
  18: {2:0.923,3:0.704,4:0.512,5:0.384,6:0.32,7:0.234,8:0.192,9:0.16,10:0.144,12:0.128,16:0.092,20:0.056,24:0.046,28:0.038,32:0.031,36:0.026},
  19: {2:0.896,3:0.65,4:0.448,5:0.32,6:0.256,7:0.192,8:0.16,9:0.144,10:0.128,12:0.096,16:0.064,20:0.048,24:0.043,28:0.035,32:0.022,36:0.025},
  20: {2:0.832,3:0.576,4:0.351,5:0.284,6:0.192,7:0.16,8:0.128,9:0.112,10:0.096,12:0.074,16:0.052,20:0.037,24:0.031,28:0.024,32:0.021,36:0.018},
  21: {2:0.798,3:0.397,4:0.284,5:0.192,6:0.16,7:0.128,8:0.096,9:0.088,10:0.08,12:0.056,16:0.04,20:0.034,24:0.027,28:0.024,32:0.021,36:0.016},
  22: {2:0.448,3:0.256,4:0.192,5:0.16,6:0.128,7:0.096,8:0.08,9:0.064,10:0.056,12:0.048,16:0.038,20:0.027,24:0.023,28:0.019,32:0.015,36:0.011},
  23: {2:0.384,3:0.224,4:0.189,5:0.128,6:0.096,7:0.08,8:0.07,9:0.06,10:0.05,12:0.04,16:0.028,20:0.022,24:0.016,28:0.015,32:0.013,36:0.01},
  24: {2:0.32,3:0.198,4:0.176,5:0.096,6:0.08,7:0.064,8:0.056,9:0.048,10:0.04,12:0.032,16:0.024,20:0.016,24:0.014,28:0.011,32:0.01,36:0.009},
  25: {2:0.256,3:0.188,4:0.128,5:0.096,6:0.064,7:0.056,8:0.048,9:0.04,10:0.032,12:0.025,16:0.018,20:0.015,24:0.011,28:0.01,32:0.009,36:0.008},
  26: {2:0.192,3:0.128,4:0.096,5:0.064,6:0.056,7:0.048,8:0.04,9:0.032,10:0.028,12:0.023,16:0.017,20:0.013,24:0.009,28:0.008,32:0.008,36:0.007},
  27: {2:0.16,3:0.126,4:0.094,5:0.058,6:0.048,7:0.04,8:0.032,9:0.028,10:0.024,12:0.02,16:0.015,20:0.009,24:0.008,28:0.007,32:0.006,36:0.005},
  28: {2:0.128,3:0.096,4:0.08,5:0.053,6:0.043,7:0.032,8:0.028,9:0.024,10:0.02,12:0.016,16:0.014,20:0.008,24:0.006,28:0.006,32:0.005,36:0.004},
  29: {2:0.122,3:0.09,4:0.056,5:0.048,6:0.04,7:0.03,8:0.024,9:0.021,10:0.018,12:0.014,16:0.01,20:0.006,24:0.004,28:0.005,32:0.003,36:0.002},
  30: {2:0.118,3:0.086,4:0.048,5:0.04,6:0.032,7:0.024,8:0.02,9:0.018,10:0.016,12:0.012,16:0.008,20:0.006,24:0.004,28:0.004,32:0.003,36:0.001}
};

/* ============================================================
   STORAGE
============================================================ */

function saveProfilesToStorage(obj) {
  localStorage.setItem(PROFILES_KEY, JSON.stringify(obj));
}

function loadProfilesFromStorage() {
  const raw = localStorage.getItem(PROFILES_KEY);
  if (!raw) return {};
  try { return JSON.parse(raw); }
  catch { return {}; }
}

function saveStateToStorage(state) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadStateFromStorage() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return null;
  try { return JSON.parse(raw); }
  catch { return null; }
}

/* ============================================================
   UI EXTRA FUNCTIONS
============================================================ */

function applyStateToUI(s) {

  // shape
  if (s.shape) {
    const radio = document.querySelector(`input[name="shape"][value="${s.shape}"]`);
    if (radio) radio.checked = true;
  }

  // mode
  if (s.mode) {
    const radio = document.querySelector(`input[name="mode"][value="${s.mode}"]`);
    if (radio) radio.checked = true;
  }

  if (typeof s.diameter === "number") document.getElementById("diameter").value = s.diameter;
  if (typeof s.length === "number") document.getElementById("length").value = s.length;
  if (typeof s.width === "number") document.getElementById("width").value = s.width;

  if (typeof s.doughPerPizzaInput === "number")
    document.getElementById("doughPerPizzaInput").value = s.doughPerPizzaInput;

  const setDisp = (id, val, dec=0) => {
    const el = document.getElementById(id);
    if (!el || typeof val !== "number") return;
    const f = Math.pow(10,dec);
    el.textContent = (Math.round(val*f)/f).toFixed(dec);
  };

  setDisp("pizzaCount", s.pizzaCount, 0);
  setDisp("hours",      s.hours, 1);
  setDisp("tempC",      s.tempC, 1);

  setDisp("thickness",  s.thicknessFactor, 2);

  setDisp("hydration",  s.hydrationPct, 0);
  setDisp("saltPct",    s.saltPct, 1);
  setDisp("oilPct",     s.oilPct, 1);
  setDisp("sugarPct",   s.sugarPct, 1);

  setDisp("yeastScale",   s.yeastScale, 2);
  setDisp("yeastOverride", s.yeastOverridePct, 2);

  if (typeof s.yeastOverridePct === "number")
    document.getElementById("yeastOverrideEnabled").checked = true;
  else
    document.getElementById("yeastOverrideEnabled").checked = false;
}

function getStateFromUI() {
  const shape = document.querySelector("input[name='shape']:checked").value;
  const mode  = document.querySelector("input[name='mode']:checked").value;

  return {
    shape,
    mode,
    diameter: Number(document.getElementById("diameter").value),
    length:   Number(document.getElementById("length").value),
    width:    Number(document.getElementById("width").value),

    thicknessFactor: Number(document.getElementById("thickness").textContent),
    doughPerPizzaInput: Number(document.getElementById("doughPerPizzaInput").value),

    pizzaCount: Number(document.getElementById("pizzaCount").textContent),
    hours:      Number(document.getElementById("hours").textContent),
    tempC:      Number(document.getElementById("tempC").textContent),

    hydrationPct: Number(document.getElementById("hydration").textContent),
    saltPct:      Number(document.getElementById("saltPct").textContent),
    oilPct:       Number(document.getElementById("oilPct").textContent),
    sugarPct:     Number(document.getElementById("sugarPct").textContent),

    yeastScale:      Number(document.getElementById("yeastScale").textContent),
    yeastOverridePct: document.getElementById("yeastOverrideEnabled").checked
        ? Number(document.getElementById("yeastOverride").textContent)
        : null
  };
}

/* ============================================================
   VISIBILITY
============================================================ */

function updateVisibility() {
  const shape = document.querySelector("input[name='shape']:checked").value;
  const mode = document.querySelector("input[name='mode']:checked").value;

  document.getElementById("roundFields").style.display = shape === "round" ? "block" : "none";
  document.getElementById("rectFields").style.display  = shape === "rect"  ? "block" : "none";

  document.getElementById("thicknessRow").style.display       = mode === "thickness" ? "block" : "none";
  document.getElementById("doughPerPizzaRow").style.display   = mode === "weight" ? "block" : "none";
}

/* ============================================================
   YEAST INTERPOLATION
============================================================ */

function interpolateYeastTable(temp, hours) {
  const t = Math.round(temp);
  const dict = yeastTable[t];
  if (!dict) return 0.3;

  const keys = Object.keys(dict).map(Number).sort((a,b)=>a-b);

  let low = null, high = null;

  for (let k of keys) {
    if (k === hours) return dict[k];
    if (k < hours) low = k;
    if (k > hours) { high = k; break; }
  }

  if (low === null) return dict[keys[0]];
  if (high === null) return dict[keys[keys.length-1]];

  const v1 = dict[low];
  const v2 = dict[high];
  return v1 + (v2-v1)*((hours-low)/(high-low));
}

/* ============================================================
   COMPUTE
============================================================ */

function computePizzaRecipe(s) {

  let area =
    s.shape === "round"
      ? Math.PI * Math.pow(s.diameter/2,2)
      : (s.length * s.width);

  let doughPerPizza = 0;

  if (s.mode === "thickness") {
    doughPerPizza = s.thicknessFactor * area;
  } else {
    doughPerPizza = s.doughPerPizzaInput;
  }

  const totalWeight = doughPerPizza * s.pizzaCount;

  // yeast
  let yeastPct;
  if (s.yeastOverridePct != null) {
    yeastPct = s.yeastOverridePct;
  } else {
    const y = interpolateYeastTable(s.tempC, s.hours);
    yeastPct = y * s.yeastScale;
  }

  const flour = totalWeight / (1 +
       s.hydrationPct/100 +
       s.saltPct/100 +
       s.oilPct/100 +
       s.sugarPct/100 +
       yeastPct/100);

  const water = flour * (s.hydrationPct/100);
  const salt  = flour * (s.saltPct/100);
  const oil   = flour * (s.oilPct/100);
  const sugar = flour * (s.sugarPct/100);
  const yeast = flour * (yeastPct/100);

  return {
    doughPerPizza,
    totalWeight,
    ingredients:{flour, water, salt, oil, sugar, yeast}
  };
}

/* ============================================================
   RENDER
============================================================ */

function renderResults(r, s) {
  document.getElementById("resultSingle").textContent =
    `××©×§×œ ×œ×›×“×•×¨: ${Math.round(r.doughPerPizza)} ×’×¨×`;

  document.getElementById("resultTotal").textContent =
    `×¡×”×´×› ×‘×¦×§: ${Math.round(r.totalWeight)} ×’×¨×`;

  document.getElementById("resultIngredients").innerHTML = `
    ×§××—: ${Math.round(r.ingredients.flour)} ×’×¨×<br>
    ××™× (${s.hydrationPct}%): ${Math.round(r.ingredients.water)} ×’×¨×<br>
    ××œ×— (${s.saltPct}%): ${Math.round(r.ingredients.salt)} ×’×¨×<br>
    ×©××Ÿ (${s.oilPct}%): ${Math.round(r.ingredients.oil)} ×’×¨×<br>
    ×¡×•×›×¨ (${s.sugarPct}%): ${Math.round(r.ingredients.sugar)} ×’×¨×<br>
    ×©××¨×™×: ${r.ingredients.yeast.toFixed(2)} ×’×¨×
  `;
}

/* ============================================================
   CALC LOOP
============================================================ */

const recalc = debounce(() => {
  const s = getStateFromUI();
  const r = computePizzaRecipe(s);
  renderResults(r, s);
  saveStateToStorage(s);

  const dirty = isProfileDirty(s);
  updateProfileDirtyWarning(dirty);
});

/* ============================================================
   STEPPERS
============================================================ */

function setupSteppers() {
  document.querySelectorAll(".step-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id  = btn.dataset.target;
      const step = Number(btn.dataset.step);

      if (["diameter","length","width","doughPerPizzaInput"].includes(id)) {
        const el = document.getElementById(id);
        el.value = Number(el.value)+step;
        recalc();
        return;
      }

      const el = document.getElementById(id);
      const cur = Number(el.textContent);
      const next = cur+step;

      if (id==="pizzaCount" && next<1) return;
      if (id==="hours" && (next<3 || next>36)) return;
      if (id==="tempC" && (next<14||next>30)) return;
      if (id==="hydration" && (next<40||next>90)) return;
      if (id==="saltPct"  && (next<0||next>5)) return;
      if (id==="oilPct"   && (next<0||next>5)) return;
      if (id==="sugarPct" && (next<0||next>5)) return;

      el.textContent = next.toFixed( id==="thickness"?2 : (id==="tempC"||id==="hours"?1:2) );
      recalc();
    });
  });
}

/* ============================================================
   PROFILE EVENTS
============================================================ */

function populateProfileSelect(obj) {
  const sel = document.getElementById("profileSelect");
  sel.innerHTML = `<option value="">×œ×œ× ×¤×¨×•×¤×™×œ</option>`;
  Object.keys(obj).forEach(name=>{
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent=
      name===currentProfileName ? 
      `${name}${currentProfileBase?'':''}` :
      name;
    sel.appendChild(opt);
  });
}

function setupProfileEvents() {

  const sel = document.getElementById("profileSelect");
  const saveBtn = document.getElementById("saveProfileBtn");
  const reloadBtn = document.getElementById("reloadProfileBtn");
  const deleteBtn = document.getElementById("deleteProfileBtn");

  // change profile
  sel.addEventListener("change", ()=>{
    const name = sel.value;
    const profiles = loadProfilesFromStorage();

    if (!name) {
      currentProfileName="";
      currentProfileBase=null;
      updateProfileDirtyWarning(false);
      recalc();
      return;
    }

    const s = profiles[name];
    if (!s) return;

    applyStateToUI(s);
    updateVisibility();

    currentProfileName = name;
    currentProfileBase = JSON.parse(JSON.stringify(s));

    updateProfileDirtyWarning(false);
    recalc();
  });

  // save
  saveBtn.addEventListener("click", ()=>{
    const name = prompt("×©× ×”×¤×¨×•×¤×™×œ:");
    if (!name) return;

    const trimmed = name.trim();
    if (!trimmed) return;

    const profiles = loadProfilesFromStorage();

    if (profiles.hasOwnProperty(trimmed)) {
      const overwrite=confirm(`×”×¤×¨×•×¤×™×œ "${trimmed}" ×§×™×™×. ×œ×“×¨×•×¡?`);
      if (!overwrite) return;
    }

    const full = getStateFromUI();

    const profileState = {
      shape: full.shape,
      mode: full.mode,
      diameter: full.diameter,
      length: full.length,
      width: full.width,
      thicknessFactor: full.thicknessFactor,
      doughPerPizzaInput: full.doughPerPizzaInput,
      hydrationPct: full.hydrationPct,
      saltPct: full.saltPct,
      oilPct: full.oilPct,
      sugarPct: full.sugarPct,
      yeastScale: full.yeastScale,
      yeastOverridePct: full.yeastOverridePct
    };

    profiles[trimmed] = profileState;
    saveProfilesToStorage(profiles);
    populateProfileSelect(profiles);
    sel.value = trimmed;

    currentProfileName = trimmed;
    currentProfileBase = profileState;

    updateProfileDirtyWarning(false);
    recalc();
  });

  // reload (fixes your bug)
  reloadBtn.addEventListener("click", ()=>{
    if (!currentProfileBase) return;

    applyStateToUI(currentProfileBase);
    updateVisibility();

    updateProfileDirtyWarning(false);
    recalc();
  });

  // delete
  deleteBtn.addEventListener("click", ()=>{
    const name = sel.value;
    if (!name) {
      alert("××™×Ÿ ×¤×¨×•×¤×™×œ ×œ××—×™×§×”.");
      return;
    }

    if (!confirm(`×œ××—×•×§ ××ª ×”×¤×¨×•×¤×™×œ "${name}"?`)) return;
    const profiles = loadProfilesFromStorage();

    delete profiles[name];
    saveProfilesToStorage(profiles);
    populateProfileSelect(profiles);
    sel.value="";

    if (currentProfileName===name) {
      currentProfileName="";
      currentProfileBase=null;
      updateProfileDirtyWarning(false);
    }

    recalc();
  });
}

/* ============================================================
   INIT
============================================================ */

document.addEventListener("DOMContentLoaded", ()=>{

  setupSteppers();
  setupProfileEvents();
  updateVisibility();

  const saved = loadStateFromStorage();
  if (saved) {
    applyStateToUI(saved);
    updateVisibility();
  }

  const profiles = loadProfilesFromStorage();
  populateProfileSelect(profiles);

  updateProfileDirtyWarning(false);

  recalc();
});

</script>

</body>
</html>
