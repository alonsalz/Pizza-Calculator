<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Pizza Calculator</title>

  <!-- Version: v4 (×œ× ××•×¦×’ ×‘××¤×œ×™×§×¦×™×”) -->

  <meta name="apple-mobile-web-app-title" content="Pizza Calculator">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Ctext y='0.9em' font-size='96'%3EğŸ•%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

  <style>
    :root {
      --bg: #F8F2EB;

      --block1: #E8FAFF; /* ×’×•×“×œ ×¤×™×¦×” */
      --block2: #EDF6FF; /* ×”×ª×¤×—×” */
      --block3: #F4FFF4; /* ××¨×›×™×‘×™ ×”×‘×¦×§ */
      --block5: #F2EEFF; /* ×ª×•×¦××•×ª */

      --accent: #e4572e;
      --accent-soft: #ffe2d5;
      --accent-text: #5a2a1b;

      --border-soft: #e2d3c2;
      --error: #b00020;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 1rem;
      background: radial-gradient(circle at top, #FFF8F0 0, var(--bg) 60%);
      color: #222;
      font-size: 16px;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding-bottom: 2rem;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.8rem;
      text-align: center;
      color: var(--accent-text);
    }

    .block {
      border-radius: 12px;
      padding: 0.75rem 1rem 1rem;
      margin-bottom: 0.85rem;
      box-shadow: 0 6px 14px rgba(0,0,0,0.05);
      border: 1px solid var(--border-soft);
    }

    #block-size         { background: var(--block1); position: relative; }
    #block-fermentation { background: var(--block2); }
    #block-profile      { background: var(--block3); }
    #block-results      { background: var(--block5); }

    .block-title {
      font-weight: 650;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #ddd0c9;
      padding-bottom: 0.25rem;
      color: var(--accent-text);
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.95rem;
    }

    .block-title::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .field { margin-bottom: 0.6rem; }

    .field label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .radio-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .choice-label {
      position: relative;
      cursor: pointer;
    }

    .choice-label input {
      position: absolute;
      opacity: 0;
    }

    .choice-pill {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #d0c2b6;
      background: #faf7f3;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 3.8rem;
      transition: all 0.15s ease;
    }

    .choice-label input:checked + .choice-pill {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent-text);
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }

    .step-row {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      direction: ltr;
    }

    .step-btn,
    .value-display {
      height: 2.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: 1px solid #d4c7bb;
      background: #FDF9F5;
      box-sizing: border-box;
      font-family: monospace;
      font-size: 16px;
    }

    .step-btn {
      min-width: 2rem;
      padding: 0 0.6rem;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .step-btn:active {
      background: #f1e3d7;
      transform: translateY(1px);
    }

    .value-display {
      min-width: 3.8rem;
      padding: 0 0.6rem;
    }

    .value-display.full-width {
      width: 100%;
      justify-content: center;
    }

    input[type="number"] {
      height: 2.2rem;
      padding: 0 0.6rem;
      border-radius: 6px;
      border: 1px solid #d4c7bb;
      background: #fffdf9;
      font-family: monospace;
      font-size: 16px;
      box-sizing: border-box;
      width: 4.2rem;
      text-align: center;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(228,87,46,0.22);
      background: #fff;
    }

    .small-note {
      font-size: 0.75rem;
      color: #8a7a6e;
      margin-top: 0.2rem;
    }

    .small-note.error {
      color: var(--error);
      font-weight: 600;
    }

    details summary {
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 0.35rem;
      color: var(--accent-text);
      list-style: none;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    details summary::before {
      content: "â–¾";
      font-size: 0.8rem;
    }

    details[open] summary::before {
      content: "â–´";
    }

    .hero-summary {
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent-soft), #ffeedd);
      padding: 0.55rem 0.7rem;
      margin-bottom: 0.6rem;
    }

    .hero-main {
      font-size: 0.95rem;
      font-weight: 650;
      color: var(--accent-text);
    }

    .hero-sub {
      font-size: 0.85rem;
      font-weight: 550;
      color: #4a3a2e;
      margin-top: 0.2rem;
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .results-table {
      margin-top: 0.4rem;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.3rem;
    }

    .results-table div {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 0.3rem 0.55rem;
      border-radius: 8px;
      background: rgba(255,255,255,0.78);
    }

    .results-table div span:first-child {
      font-size: 0.8rem;
      color: #5f5145;
      margin-bottom: 0.05rem;
    }

    .results-table div span:last-child {
      font-weight: 600;
      font-family: monospace;
      font-size: 0.95rem;
    }

    .profile-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .profile-row select {
      flex: 1;
      height: 2.2rem;
      border-radius: 6px;
      border: 1px solid #d4c7bb;
      background: #fffdf9;
      font-size: 0.9rem;
      padding: 0 0.4rem;
    }

    .profile-row button {
      height: 2.2rem;
      padding: 0 0.5rem;
      border-radius: 6px;
      border: 1px solid #d4c7bb;
      background: #f8f0e8;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .profile-row button:active {
      background: #f1e3d7;
      transform: translateY(1px);
    }

    /* ×”×ª××•× ×•×ª ×©×œ ×”×¤×™×¦×•×ª */
    .pizza-illustration {
      position: absolute;
      top: 64px;   /* ×™×•×ª×¨ ×œ××˜×” */
      left: 12px;
      width: 110px; /* ×™×•×ª×¨ ×’×“×•×œ×” */
      height: 110px;
      pointer-events: none;
      opacity: 0.9;
    }

    .pizza-illustration img {
      #pizzaRound {
      transform: scale(2.0);
      transform-origin: center;
      }
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Pizza Calculator</h1>

    <!-- 1. ×’×•×“×œ ×¤×™×¦×” -->
    <div class="block" id="block-size">
      <div class="block-title">×’×•×“×œ ×”×¤×™×¦×” ğŸ•</div>

      <div class="pizza-illustration">
        <img src="Round-pizza.png" alt="×¤×™×¦×” ×¢×’×•×œ×”" id="pizzaRound">
        <img src="Detroit-pizza.png" alt="×¤×™×¦×” ××œ×‘× ×™×ª" id="pizzaRect">
      </div>

      <div class="field">
        <label>×¦×•×¨×”</label>
        <div class="radio-row">
          <label class="choice-label">
            <input type="radio" name="shape" value="round" checked>
            <span class="choice-pill">×¢×’×•×œ×”</span>
          </label>
          <label class="choice-label">
            <input type="radio" name="shape" value="rect">
            <span class="choice-pill">××œ×‘× ×™×ª</span>
          </label>
        </div>
      </div>

      <div class="field" id="field-diameter">
        <label>×§×•×˜×¨ (×¡×´×)</label>
        <input type="number" id="diameter" value="30" min="1" step="0.5">
      </div>

      <div class="field" id="field-rect" style="display:none;">
        <label>××•×¨×š Ã— ×¨×•×—×‘ (×¡×´×)</label>
        <div class="row">
          <input type="number" id="length" placeholder="××•×¨×š" min="1" step="0.5">
          <input type="number" id="width" placeholder="×¨×•×—×‘" min="1" step="0.5">
        </div>
      </div>

      <div class="field">
        <label>××¡×¤×¨ ×¤×™×¦×•×ª</label>
        <div class="step-row">
          <div class="step-btn" data-target="pizzaCount" data-step="-1" data-min="1">â€“</div>
          <div class="value-display" id="pizzaCount">1</div>
          <div class="step-btn" data-target="pizzaCount" data-step="1" data-min="1">+</div>
        </div>
      </div>

      <div class="field">
        <label>××¦×‘ ×—×™×©×•×‘</label>
        <div class="radio-row">
          <label class="choice-label">
            <input type="radio" name="mode" value="thickness" checked>
            <span class="choice-pill">×§×•×‘×¢ ×¢×•×‘×™ â† ××§×‘×œ ××©×§×œ</span>
          </label>
          <label class="choice-label">
            <input type="radio" name="mode" value="weight">
            <span class="choice-pill">×§×•×‘×¢ ××©×§×œ â† ××§×‘×œ ×¢×•×‘×™</span>
          </label>
        </div>
      </div>

      <div class="field" id="field-thickness">
        <label>×¢×•×‘×™ (×’×¨× ×œ×¡×´×Â²)</label>
        <div class="step-row">
          <div class="step-btn" data-target="thickness" data-step="-0.1" data-min="0">â€“â€“</div>
          <div class="step-btn" data-target="thickness" data-step="-0.01" data-min="0">â€“</div>
          <div class="value-display" id="thickness">0.39</div>
          <div class="step-btn" data-target="thickness" data-step="0.01">+</div>
          <div class="step-btn" data-target="thickness" data-step="0.1">++</div>
        </div>
        <div class="small-note">××‘×•×¡×¡ ×¢×œ 30 ×¡×´× / 276 ×’×¨×</div>
      </div>

      <div class="field" id="field-dough-per-pizza" style="display:none;">
        <label>××©×§×œ ×‘×¦×§ ×œ×¤×™×¦×” ××—×ª (×’×¨×)</label>
        <input type="number" id="doughPerPizzaInput" value="276" min="1">
      </div>
    </div>

    <!-- 2. ×”×ª×¤×—×” -->
    <div class="block" id="block-fermentation">
      <div class="block-title">×”×ª×¤×—×” â±ï¸</div>

      <div class="field">
        <label>×–××Ÿ (×©×¢×•×ª)</label>
        <div class="step-row">
          <div class="step-btn" data-target="hours" data-step="-1" data-min="3" data-max="36">â€“â€“</div>
          <div class="step-btn" data-target="hours" data-step="-0.5">â€“</div>
          <div class="value-display" id="hours">6</div>
          <div class="step-btn" data-target="hours" data-step="0.5">+</div>
          <div class="step-btn" data-target="hours" data-step="1">++</div>
        </div>
      </div>

      <div class="field">
        <label>×˜××¤×¨×˜×•×¨×” (Â°C)</label>
        <div class="step-row">
          <div class="step-btn" data-target="tempC" data-step="-0.5" data-min="14" data-max="30">â€“</div>
          <div class="value-display" id="tempC">25</div>
          <div class="step-btn" data-target="tempC" data-step="0.5">+</div>
        </div>
      </div>
    </div>

    <!-- 3. ××¨×›×™×‘×™ ×”×‘×¦×§ -->
    <div class="block" id="block-profile">
      <div class="block-title">××¨×›×™×‘×™ ×”×‘×¦×§ ğŸ§ª</div>

      <div class="field">
        <label>×¤×¨×•×¤×™×œ ×‘×¦×§</label>
        <div class="profile-row">
          <select id="profileSelect">
            <option value="">×œ×œ× ×¤×¨×•×¤×™×œ</option>
          </select>
          <button type="button" id="saveProfileBtn">×©××•×¨</button>
          <button type="button" id="reloadProfileBtn">×©×—×–×¨</button>
          <button type="button" id="deleteProfileBtn">××—×§</button>
        </div>
        <div class="small-note">
          ×‘×—×¨ ×¤×¨×•×¤×™×œ ×§×™×™× ××• ×©××•×¨ ××ª ×”×”×’×“×¨×•×ª ×”× ×•×›×—×™×•×ª ×›×¤×¨×•×¤×™×œ ×—×“×©.
        </div>
        <div class="small-note error" id="profileDirty" style="display:none;">
          ×”×¤×¨×•×¤×™×œ ×©×•× ×”
        </div>
      </div>

      <div class="field">
        <label>×”×™×“×¨×¦×™×” (%)</label>
        <div class="step-row">
          <div class="step-btn" data-target="hydration" data-step="-5" data-min="40">â€“â€“</div>
          <div class="step-btn" data-target="hydration" data-step="-1">â€“</div>
          <div class="value-display" id="hydration">60</div>
          <div class="step-btn" data-target="hydration" data-step="1">+</div>
          <div class="step-btn" data-target="hydration" data-step="5">++</div>
        </div>
      </div>

      <div class="field">
        <label>××œ×— (%)</label>
        <div class="step-row">
          <div class="step-btn" data-target="saltPct" data-step="-0.1" data-min="0" data-max="5">â€“</div>
          <div class="value-display" id="saltPct">2.5</div>
          <div class="step-btn" data-target="saltPct" data-step="0.1">+</div>
        </div>
      </div>

      <div class="field">
        <label>×©××Ÿ (%)</label>
        <div class="step-row">
          <div class="step-btn" data-target="oilPct" data-step="-0.1" data-min="0" data-max="5">â€“</div>
          <div class="value-display" id="oilPct">2.0</div>
          <div class="step-btn" data-target="oilPct" data-step="0.1">+</div>
        </div>
      </div>

      <div class="field">
        <label>×¡×•×›×¨ (%)</label>
        <div class="step-row">
          <div class="step-btn" data-target="sugarPct" data-step="-0.1" data-min="0" data-max="5">â€“</div>
          <div class="value-display" id="sugarPct">1.0</div>
          <div class="step-btn" data-target="sugarPct" data-step="0.1">+</div>
        </div>
      </div>

      <div class="field">
        <label>×©××¨×™× (%)</label>
        <div class="value-display full-width" id="yeastPercentDisplay">0.000</div>
        <div class="small-note">
          ××—×•×©×‘ ××•×˜×•××˜×™×ª ×œ×¤×™ ×–××Ÿ ×”×”×ª×¤×—×” ×•×”×˜××¤×¨×˜×•×¨×” (× ×™×ª×Ÿ ×œ×›×•×•× ×Ÿ ×‘×”×’×“×¨×•×ª ×”××ª×§×“××•×ª).
        </div>
      </div>

      <details>
        <summary>×”×’×“×¨×•×ª ××ª×§×“××•×ª ×œ×©××¨×™×</summary>

        <div class="field">
          <label>×¡×§×™×™×œ ×œ×©××¨×™×</label>
          <div class="step-row">
            <div class="step-btn" data-target="yeastScale" data-step="-0.05" data-min="0.5" data-max="1.5">â€“</div>
            <div class="value-display" id="yeastScale">1.0</div>
            <div class="step-btn" data-target="yeastScale" data-step="0.05">+</div>
          </div>
        </div>

        <div class="field">
          <label><input type="checkbox" id="yeastOverrideEnabled"> ×§×‘×™×¢×ª ××—×•×– ×©××¨×™× ×™×“× ×™×ª</label>
        </div>

        <div class="field">
          <label>×¢×¨×š ×™×“× ×™ (%)</label>
          <div class="step-row">
            <div class="step-btn" data-target="yeastOverride" data-step="-0.01" data-min="0" data-max="2">â€“</div>
            <div class="value-display" id="yeastOverride">0.20</div>
            <div class="step-btn" data-target="yeastOverride" data-step="0.01">+</div>
          </div>
        </div>
      </details>
    </div>

    <!-- 4. ×ª×•×¦××•×ª -->
    <div class="block" id="block-results">
      <div class="block-title">×ª×•×¦××•×ª ğŸ“Š</div>

      <div class="hero-summary">
        <div class="hero-main" id="heroLineMain">â€“</div>
        <div class="hero-sub" id="heroLineSub">â€“</div>
      </div>

      <div class="results-table">
        <div><span id="flourLabel">×§××—</span><span id="flourTotalResult">â€“</span></div>
        <div><span id="waterLabel">××™×</span><span id="waterTotalResult">â€“</span></div>
        <div><span id="saltLabel">××œ×—</span><span id="saltTotalResult">â€“</span></div>
        <div><span id="oilLabel">×©××Ÿ</span><span id="oilTotalResult">â€“</span></div>
        <div><span id="sugarLabel">×¡×•×›×¨</span><span id="sugarTotalResult">â€“</span></div>
        <div><span id="yeastLabel">×©××¨×™×</span><span id="yeastTotalResult">â€“</span></div>
      </div>
    </div>

  </div>

  <script>
    /* ===== × ×ª×•× ×™ ×˜×‘×œ×ª ×”×©××¨×™× ===== */
    const TEMPS = [14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30];
    const HOURS = [2,3,4,5,6,7,8,9,10,12,16,20,24,28,32,36];

    const YEAST_TABLE = [
      [1.246,1.112,0.896,0.704,0.576,0.448,0.384,0.32,0.288,0.224,0.167,0.112,0.102,0.079,0.056,0.042],
      [1.224,0.986,0.832,0.64,0.5,0.384,0.32,0.256,0.224,0.192,0.128,0.099,0.075,0.052,0.048,0.036],
      [1.112,0.896,0.704,0.512,0.384,0.32,0.256,0.224,0.192,0.16,0.12,0.08,0.052,0.048,0.04,0.03],
      [0.968,0.768,0.576,0.39,0.32,0.256,0.224,0.192,0.16,0.128,0.099,0.064,0.048,0.04,0.032,0.028],
      [0.923,0.704,0.512,0.384,0.32,0.234,0.192,0.16,0.144,0.128,0.092,0.056,0.046,0.038,0.031,0.026],
      [0.896,0.65,0.448,0.32,0.256,0.192,0.16,0.144,0.128,0.096,0.064,0.048,0.043,0.035,0.022,0.018],
      [0.832,0.576,0.351,0.284,0.192,0.16,0.128,0.112,0.096,0.074,0.052,0.037,0.031,0.024,0.021,0.018],
      [0.798,0.397,0.284,0.192,0.16,0.128,0.096,0.088,0.08,0.056,0.04,0.034,0.027,0.024,0.021,0.016],
      [0.448,0.256,0.192,0.16,0.128,0.096,0.08,0.064,0.056,0.048,0.038,0.027,0.023,0.019,0.015,0.011],
      [0.384,0.224,0.189,0.128,0.096,0.08,0.07,0.06,0.05,0.04,0.028,0.022,0.016,0.015,0.013,0.01],
      [0.32,0.198,0.176,0.096,0.08,0.064,0.056,0.048,0.04,0.032,0.024,0.016,0.014,0.011,0.01,0.009],
      [0.256,0.188,0.128,0.096,0.064,0.056,0.048,0.04,0.032,0.025,0.018,0.015,0.011,0.01,0.009,0.008],
      [0.192,0.128,0.096,0.064,0.056,0.048,0.04,0.032,0.028,0.023,0.017,0.013,0.009,0.008,0.008,0.007],
      [0.16,0.126,0.094,0.058,0.048,0.04,0.032,0.028,0.024,0.02,0.015,0.009,0.008,0.007,0.006,0.005],
      [0.128,0.096,0.08,0.053,0.043,0.032,0.028,0.024,0.02,0.016,0.014,0.008,0.006,0.006,0.005,0.004],
      [0.122,0.09,0.056,0.048,0.04,0.03,0.024,0.021,0.018,0.014,0.01,0.006,0.004,0.005,0.003,0.002],
      [0.118,0.086,0.048,0.04,0.032,0.024,0.02,0.018,0.016,0.012,0.008,0.006,0.004,0.004,0.003,0.001]
    ];

    const STORAGE_KEY  = 'pizzaCalculatorState_v4';
    const PROFILES_KEY = 'pizzaCalculatorProfiles_v4';

    let currentProfileName = '';
    let currentProfileBase = null;

    const PROFILE_FIELDS = [
      'shape',
      'mode',
      'diameter',
      'length',
      'width',
      'thicknessFactor',
      'doughPerPizzaInput',
      'hydrationPct',
      'saltPct',
      'oilPct',
      'sugarPct',
      'yeastScale',
      'yeastOverridePct'
    ];

    function findBoundingIndices(value, arr) {
      if (value <= arr[0]) return [0,0];
      const last = arr.length-1;
      if (value >= arr[last]) return [last,last];
      for (let i=0;i<last;i++){
        if (arr[i] <= value && value <= arr[i+1]) return [i,i+1];
      }
      return [last,last];
    }

    function interpolateYeastPercent(temp, hours) {
      const [tiL,tiH] = findBoundingIndices(temp, TEMPS);
      const [hiL,hiH] = findBoundingIndices(hours, HOURS);

      const T1 = TEMPS[tiL], T2 = TEMPS[tiH];
      const H1 = HOURS[hiL], H2 = HOURS[hiH];

      const Q11 = YEAST_TABLE[tiL][hiL];
      const Q12 = YEAST_TABLE[tiL][hiH];
      const Q21 = YEAST_TABLE[tiH][hiL];
      const Q22 = YEAST_TABLE[tiH][hiH];

      const t = (T2 === T1 ? 0 : (temp - T1) / (T2 - T1));
      const h = (H2 === H1 ? 0 : (hours - H1) / (H2 - H1));

      const V1 = Q11 + (Q12 - Q11) * h;
      const V2 = Q21 + (Q22 - Q21) * h;

      return V1 + (V2 - V1) * t;
    }

    function getYeastPercent(temp, hours, scale, override) {
      let val;
      if (override !== null && override !== undefined) val = override;
      else val = interpolateYeastPercent(temp, hours) * scale;

      if (val < 0.001) val = 0.001;
      if (val > 2) val = 2;
      return Math.round(val * 1000) / 1000;
    }

    function getStateFromUI() {
      const get = id => parseFloat(document.getElementById(id).textContent);
      const getInput = id => {
        const el = document.getElementById(id);
        if (!el) return 0;
        const v = parseFloat(el.value);
        return isNaN(v) ? 0 : v;
      };

      const shape = document.querySelector('input[name="shape"]:checked').value;
      const mode  = document.querySelector('input[name="mode"]:checked').value;

      return {
        shape: shape,
        diameter: getInput('diameter'),
        length:   getInput('length'),
        width:    getInput('width'),
        pizzaCount: get('pizzaCount'),
        mode: mode,
        thicknessFactor: get('thickness'),
        doughPerPizzaInput: getInput('doughPerPizzaInput'),
        hours: get('hours'),
        tempC: get('tempC'),
        hydrationPct: get('hydration'),
        saltPct: get('saltPct'),
        oilPct: get('oilPct'),
        sugarPct: get('sugarPct'),
        yeastScale: get('yeastScale') || 1.0,
        yeastOverridePct:
          document.getElementById('yeastOverrideEnabled').checked
            ? get('yeastOverride')
            : null
      };
    }

    function computePizzaRecipe(s) {
      let area =
        s.shape === 'round'
          ? Math.PI * (s.diameter / 2) ** 2
          : (s.length || 0) * (s.width || 0);

      let doughPerPizza = s.mode === 'thickness'
        ? area * s.thicknessFactor
        : s.doughPerPizzaInput;

      let thickness = s.mode === 'thickness'
        ? s.thicknessFactor
        : (area ? doughPerPizza / area : 0);

      const doughTotal = doughPerPizza * s.pizzaCount;

      const H = s.hydrationPct / 100;
      const A = s.saltPct / 100;
      const O = s.oilPct / 100;
      const U = s.sugarPct / 100;

      const factor = 1 + H + A + O + U;

      const flour = factor ? (doughTotal / factor) : 0;
      const water = flour * H;
      const salt  = flour * A;
      const oil   = flour * O;
      const sugar = flour * U;

      const yeastPct = getYeastPercent(s.tempC, s.hours, s.yeastScale, s.yeastOverridePct);
      const yeast = flour * yeastPct / 100;

      const r0 = x => Math.round(x);
      const r1 = x => Math.round(x * 10) / 10;
      const r2 = x => Math.round(x * 100) / 100;
      const r3 = x => Math.round(x * 1000) / 1000;

      return {
        doughPerPizza: r0(doughPerPizza),
        doughTotal:    r0(doughTotal),
        ballWeight:    r0(doughPerPizza),

        flourTotal: r0(flour),
        waterTotal: r0(water),
        saltTotal:  r1(salt),
        oilTotal:   r1(oil),
        sugarTotal: r1(sugar),
        yeastTotal: r2(yeast),

        yeastPercent: r3(yeastPct),
        thickness: thickness
      };
    }

    function renderResults(result, s) {
      const shapeText =
        s.shape === 'round' ? '×¢×’×•×œ×•×ª' : '××œ×‘× ×™×•×ª';
      const sizeText =
        s.shape === 'round'
          ? `${s.diameter} ×¡×´×`
          : `${s.length}Ã—${s.width} ×¡×´×`;

      document.getElementById('heroLineMain').textContent =
        `${s.pizzaCount} ×¤×™×¦×•×ª ${shapeText}, ${sizeText}`;

      document.getElementById('heroLineSub').textContent =
        `××©×§×œ ×œ×›×“×•×¨: ${result.ballWeight} ×’×¨× Â· ×¡×”×´×› ×‘×¦×§: ${result.doughTotal} ×’×¨×`;

      document.getElementById('flourLabel').textContent = '×§××—:';
      document.getElementById('waterLabel').textContent =
        `××™× (${s.hydrationPct}%):`;
      document.getElementById('saltLabel').textContent =
        `××œ×— (${s.saltPct}%):`;
      document.getElementById('oilLabel').textContent  =
        `×©××Ÿ (${s.oilPct}%):`;
      document.getElementById('sugarLabel').textContent =
        `×¡×•×›×¨ (${s.sugarPct}%):`;
      document.getElementById('yeastLabel').textContent =
        `×©××¨×™× (${result.yeastPercent}%):`;

      document.getElementById('flourTotalResult').textContent =
        result.flourTotal + ' ×’×¨×';
      document.getElementById('waterTotalResult').textContent =
        result.waterTotal + ' ×’×¨×';
      document.getElementById('saltTotalResult').textContent  =
        result.saltTotal + ' ×’×¨×';
      document.getElementById('oilTotalResult').textContent   =
        result.oilTotal + ' ×’×¨×';
      document.getElementById('sugarTotalResult').textContent =
        result.sugarTotal + ' ×’×¨×';
      document.getElementById('yeastTotalResult').textContent =
        result.yeastTotal + ' ×’×¨×';

      document.getElementById('yeastPercentDisplay').textContent =
        result.yeastPercent.toString();
    }

    function applyStateToUI(s) {
      if (s.shape === 'round' || s.shape === 'rect') {
        const shapeRadio = document.querySelector(
          'input[name="shape"][value="' + s.shape + '"]'
        );
        if (shapeRadio) shapeRadio.checked = true;
      }

      if (s.mode === 'thickness' || s.mode === 'weight') {
        const modeRadio = document.querySelector(
          'input[name="mode"][value="' + s.mode + '"]'
        );
        if (modeRadio) modeRadio.checked = true;
      }

      if (typeof s.diameter === 'number') {
        document.getElementById('diameter').value = s.diameter;
      }
      if (typeof s.length === 'number') {
        document.getElementById('length').value = s.length;
      }
      if (typeof s.width === 'number') {
        document.getElementById('width').value = s.width;
      }
      if (typeof s.doughPerPizzaInput === 'number') {
        document.getElementById('doughPerPizzaInput').value = s.doughPerPizzaInput;
      }

      const setDisplay = function(id, val, decimals) {
        if (typeof val !== 'number' || isNaN(val)) return;
        const el = document.getElementById(id);
        if (!el) return;
        const factor = Math.pow(10, decimals);
        const v = Math.round(val * factor) / factor;
        el.textContent = v.toFixed(decimals);
      };

      if (typeof s.pizzaCount === 'number') setDisplay('pizzaCount', s.pizzaCount, 0);
      if (typeof s.thicknessFactor === 'number') setDisplay('thickness', s.thicknessFactor, 2);
      if (typeof s.hours === 'number') setDisplay('hours', s.hours, 1);
      if (typeof s.tempC === 'number') setDisplay('tempC', s.tempC, 1);

      setDisplay('hydration',  s.hydrationPct, 0);
      setDisplay('saltPct',    s.saltPct, 1);
      setDisplay('oilPct',     s.oilPct, 1);
      setDisplay('sugarPct',   s.sugarPct, 1);

      setDisplay('yeastScale',    s.yeastScale, 2);
      if (s.yeastOverridePct !== null && s.yeastOverridePct !== undefined) {
        setDisplay('yeastOverride', s.yeastOverridePct, 2);
      }

      document.getElementById('yeastOverrideEnabled').checked =
        (s.yeastOverridePct !== null && s.yeastOverridePct !== undefined);
    }

    function saveStateToStorage(state) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        /* ××ª×¢×œ××™× */
      }
    }

    function loadStateFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);
        applyStateToUI(s);
      } catch (e) {
        /* ××ª×¢×œ××™× */
      }
    }

    function loadProfilesFromStorage() {
      try {
        const raw = localStorage.getItem(PROFILES_KEY);
        if (!raw) return {};
        const obj = JSON.parse(raw);
        return (obj && typeof obj === 'object') ? obj : {};
      } catch (e) {
        return {};
      }
    }

    function saveProfilesToStorage(profiles) {
      try {
        localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
      } catch (e) {
        /* ××ª×¢×œ××™× */
      }
    }

    function populateProfileSelect(profiles) {
      const select = document.getElementById('profileSelect');
      if (!select) return;

      const currentValue = select.value;

      while (select.options.length > 1) {
        select.remove(1);
      }

      Object.keys(profiles).forEach(function(name) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });

      if (currentValue && profiles[currentValue]) {
        select.value = currentValue;
      } else {
        select.value = '';
      }
    }

    function setProfileDirtyIndicator(isDirty) {
      const el = document.getElementById('profileDirty');
      if (!el) return;
      el.style.display = isDirty ? 'block' : 'none';
    }

    function isCurrentProfileDirty(state) {
      if (!currentProfileName || !currentProfileBase) return false;
      const p = currentProfileBase;

      for (let i = 0; i < PROFILE_FIELDS.length; i++) {
        const key = PROFILE_FIELDS[i];
        const v1 = p[key];
        const v2 = state[key];

        if (key === 'shape' || key === 'mode') {
          if (v1 !== v2) return true;
        } else {
          const n1 = (v1 === null || v1 === undefined) ? 0 : Number(v1);
          const n2 = (v2 === null || v2 === undefined) ? 0 : Number(v2);
          if (Math.abs(n1 - n2) > 1e-6) return true;
        }
      }
      return false;
    }

    function setupProfileEvents() {
      const select = document.getElementById('profileSelect');
      const saveBtn = document.getElementById('saveProfileBtn');
      const deleteBtn = document.getElementById('deleteProfileBtn');
      const reloadBtn = document.getElementById('reloadProfileBtn');

      if (!select || !saveBtn || !deleteBtn || !reloadBtn) return;

      saveBtn.addEventListener('click', function() {
        const name = prompt('×©× ×”×¤×¨×•×¤×™×œ ×œ×©××™×¨×”:');
        if (!name) return;

        const trimmed = name.trim();
        if (!trimmed) return;

        const profiles = loadProfilesFromStorage();

        if (profiles.hasOwnProperty(trimmed)) {
          const overwrite = confirm('×¤×¨×•×¤×™×œ ×‘×©× "' + trimmed + '" ×›×‘×¨ ×§×™×™×.\n\n×œ×“×¨×•×¡ ××•×ª×•?');
          if (!overwrite) return;
        }

        const full = getStateFromUI();

        const profileState = {
          shape: full.shape,
          mode: full.mode,
          diameter: full.diameter,
          length: full.length,
          width: full.width,
          thicknessFactor: full.thicknessFactor,
          doughPerPizzaInput: full.doughPerPizzaInput,
          hydrationPct: full.hydrationPct,
          saltPct: full.saltPct,
          oilPct: full.oilPct,
          sugarPct: full.sugarPct,
          yeastScale: full.yeastScale,
          yeastOverridePct: full.yeastOverridePct
        };

        profiles[trimmed] = profileState;
        saveProfilesToStorage(profiles);
        populateProfileSelect(profiles);
        select.value = trimmed;

        currentProfileName = trimmed;
        currentProfileBase = profileState;
        setProfileDirtyIndicator(false);
      });

      deleteBtn.addEventListener('click', function() {
        const current = select.value;
        if (!current) {
          alert('×œ× × ×‘×—×¨ ×¤×¨×•×¤×™×œ ×œ××—×™×§×”.');
          return;
        }

        if (!confirm('×œ××—×•×§ ××ª ×”×¤×¨×•×¤×™×œ "' + current + '"?')) return;

        const profiles = loadProfilesFromStorage();
        delete profiles[current];
        saveProfilesToStorage(profiles);
        populateProfileSelect(profiles);

        if (currentProfileName === current) {
          currentProfileName = '';
          currentProfileBase = null;
          setProfileDirtyIndicator(false);
        }
      });

      select.addEventListener('change', function() {
        const name = select.value;
        if (!name) {
          currentProfileName = '';
          currentProfileBase = null;
          setProfileDirtyIndicator(false);
          recalc();
          return;
        }

        const profiles = loadProfilesFromStorage();
        const s = profiles[name];
        if (!s) return;

        applyStateToUI(s);
        updateVisibility();

        currentProfileName = name;
        currentProfileBase = s;
        setProfileDirtyIndicator(false);

        recalc();
      });

      reloadBtn.addEventListener('click', function() {
        const name = select.value;
        if (!name) return;

        const profiles = loadProfilesFromStorage();
        const s = profiles[name];
        if (!s) return;

        applyStateToUI(s);
        updateVisibility();

        currentProfileName = name;
        currentProfileBase = s;
        setProfileDirtyIndicator(false);

        recalc();
      });
    }

    function updateVisibility() {
      const shape =
        document.querySelector('input[name="shape"]:checked').value;
      const mode  =
        document.querySelector('input[name="mode"]:checked').value;

      document.getElementById('field-diameter').style.display =
        shape === 'round' ? 'block' : 'none';
      document.getElementById('field-rect').style.display =
        shape === 'rect' ? 'block' : 'none';

      document.getElementById('field-thickness').style.display =
        mode === 'thickness' ? 'block' : 'none';
      document.getElementById('field-dough-per-pizza').style.display =
        mode === 'weight' ? 'block' : 'none';

      const roundImg = document.getElementById('pizzaRound');
      const rectImg  = document.getElementById('pizzaRect');
      if (roundImg && rectImg) {
        if (shape === 'round') {
          roundImg.style.display = 'block';
          rectImg.style.display  = 'none';
        } else {
          roundImg.style.display = 'none';
          rectImg.style.display  = 'block';
        }
      }
    }

    function debounce(fn, delay) {
      let t;
      return function() {
        const args = arguments;
        clearTimeout(t);
        t = setTimeout(function() {
          fn.apply(null, args);
        }, delay);
      };
    }

    const recalc = debounce(function() {
      const s = getStateFromUI();
      const r = computePizzaRecipe(s);
      renderResults(r, s);
      saveStateToStorage(s);

      const dirty = isCurrentProfileDirty(s);
      setProfileDirtyIndicator(dirty);
    }, 120);

    function setupSteppers() {
      const btns = document.querySelectorAll('.step-btn');
      btns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const id   = btn.dataset.target;
          const step = parseFloat(btn.dataset.step);
          const min  = btn.dataset.min ? parseFloat(btn.dataset.min) : null;
          const max  = btn.dataset.max ? parseFloat(btn.dataset.max) : null;

          const el = document.getElementById(id);
          let val = parseFloat(el.textContent);
          if (isNaN(val)) val = 0;

          let next = val + step;
          if (min !== null) next = Math.max(min, next);
          if (max !== null) next = Math.min(max, next);

          const decimals = (step.toString().split('.')[1] || '').length;
          const f = Math.pow(10, decimals);
          next = Math.round(next * f) / f;

          el.textContent = next.toFixed(decimals);
          recalc();
        });
      });
    }

    function setupInputs() {
      ['diameter', 'length', 'width', 'doughPerPizzaInput'].forEach(function(id) {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', recalc);
      });
    }

    function setupRadios() {
      document.querySelectorAll('input[name="shape"]').forEach(function(r) {
        r.addEventListener('change', function() {
          updateVisibility();
          recalc();
        });
      });
      document.querySelectorAll('input[name="mode"]').forEach(function(r) {
        r.addEventListener('change', function() {
          updateVisibility();
          recalc();
        });
      });
      document.getElementById('yeastOverrideEnabled')
        .addEventListener('change', recalc);
    }

    document.addEventListener('DOMContentLoaded', function() {
      setupSteppers();
      setupInputs();
      setupRadios();

      const profiles = loadProfilesFromStorage();
      populateProfileSelect(profiles);
      setupProfileEvents();

      loadStateFromStorage();
      updateVisibility();
      recalc();
    });
  </script>
</body>
</html>



